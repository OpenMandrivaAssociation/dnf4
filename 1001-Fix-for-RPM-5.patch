From 8a7213da4789e59235f10de6cb42531f72aea604 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Elan=20Ruusam=C3=A4e?= <glen@delfi.ee>
Date: Sat, 31 Jan 2015 20:48:14 +0200
Subject: [PATCH 1001/1005] Fix for RPM 5

---
 dnf/base.py            | 9 ++++-----
 dnf/rpm/__init__.py    | 2 +-
 dnf/rpm/transaction.py | 2 +-
 3 files changed, 6 insertions(+), 7 deletions(-)

diff --git a/dnf/base.py b/dnf/base.py
index eade03d1..bcbb553a 100644
--- a/dnf/base.py
+++ b/dnf/base.py
@@ -334,10 +334,9 @@ class Base(object):
                         'nodocs': rpm.RPMTRANS_FLAG_NODOCS,
                         'test': rpm.RPMTRANS_FLAG_TEST,
                         'justdb': rpm.RPMTRANS_FLAG_JUSTDB,
-                        'nocontexts': rpm.RPMTRANS_FLAG_NOCONTEXTS,
-                        'nocrypto': rpm.RPMTRANS_FLAG_NOFILEDIGEST}
-    _TS_VSFLAGS_TO_RPM = {'nocrypto': rpm._RPMVSF_NOSIGNATURES |
-                          rpm._RPMVSF_NODIGESTS}
+                        'nocontexts': 0,
+                        'nocrypto': 0}
+    _TS_VSFLAGS_TO_RPM = {'nocrypto': rpm.RPMVSF_NODSAHEADER }
 
     @property
     def _ts(self):
@@ -1391,7 +1390,7 @@ class Base(object):
 
         installroot = self.conf.installroot
         myts = dnf.rpm.transaction.initReadOnlyTransaction(root=installroot)
-        myts.pushVSFlags(~(rpm._RPMVSF_NOSIGNATURES | rpm._RPMVSF_NODIGESTS))
+        myts.pushVSFlags(~rpm.RPMVSF_NODSAHEADER)
         idx = myts.dbMatch('name', 'gpg-pubkey')
         keys = len(idx)
         del idx
diff --git a/dnf/rpm/__init__.py b/dnf/rpm/__init__.py
index adc758b0..8b87bec1 100644
--- a/dnf/rpm/__init__.py
+++ b/dnf/rpm/__init__.py
@@ -30,7 +30,7 @@ def detect_releasever(installroot):
     """Calculate the release version for the system. :api"""
 
     ts = transaction.initReadOnlyTransaction(root=installroot)
-    ts.pushVSFlags(~(rpm._RPMVSF_NOSIGNATURES | rpm._RPMVSF_NODIGESTS))
+    ts.pushVSFlags(~rpm.RPMVSF_NODSAHEADER)
     for distroverpkg in dnf.const.DISTROVERPKG:
         try:
             idx = ts.dbMatch('provides', distroverpkg)
diff --git a/dnf/rpm/transaction.py b/dnf/rpm/transaction.py
index cfb4f61e..ff08d526 100644
--- a/dnf/rpm/transaction.py
+++ b/dnf/rpm/transaction.py
@@ -119,5 +119,5 @@ class TransactionWrapper(object):
 
 def initReadOnlyTransaction(root='/'):
     read_ts =  TransactionWrapper(root=root)
-    read_ts.pushVSFlags((rpm._RPMVSF_NOSIGNATURES|rpm._RPMVSF_NODIGESTS))
+    read_ts.pushVSFlags(rpm.RPMVSF_NODSAHEADER)
     return read_ts
-- 
2.14.1

